<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Kotlin Coroutines 정리: 2</title>
    <meta name="description" content="Develop and Write" />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/balloon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="/2023-09-23-Kotlin-Coroutines-2" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="15balloon" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Kotlin Coroutines 정리: 2" />
    <meta property="og:description" content="Develop and Write" />
    <meta property="og:url" content="/2023-09-23-Kotlin-Coroutines-2" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Kotlin Coroutines 정리: 2" />
    <meta name="twitter:description" content="Develop and Write" />
    <meta name="twitter:url" content="/2023-09-23-Kotlin-Coroutines-2" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "15balloon",
    "name": "Kotlin Coroutines 정리: 2",
    "url": "/2023-09-23-Kotlin-Coroutines-2",
    "image": "/assets/images/cover1.jpg",
    "description": "Develop and Write"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="15balloon" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-android " role="presentation"><a href="/tag/android">Android</a></li>
        <li class="nav-conference " role="presentation"><a href="/tag/conference">Conference</a></li>
        <li class="nav-error " role="presentation"><a href="/tag/error">Error</a></li>
        <li class="nav-flutter " role="presentation"><a href="/tag/flutter">Flutter</a></li>
        <li class="nav-author " role="presentation"><a href="/author/15balloon">15balloon</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/cover1.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/15balloon.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-test tag-content">

        <header class="post-header">
            <h1 class="post-title">Kotlin Coroutines 정리: 2</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
                    <a href='/author/15balloon'>15balloon</a>
                
            
            <time class="post-date" datetime="2023-09-23">23 Sep 2023</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/android'>Android</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <h4 id="launch--async">Launch &amp; Async</h4>
<ul>
  <li>launch - 새로운 Coroutine을 시작하며 호출자에게 결과를 반환하지 않는다.</li>
  <li>async - 새로운 Coroutine을 시작하며 <em>await</em>라는 suspend 함수로 결과를 반환할 수 있다.</li>
</ul>

<p>async는 Coroutine 내부에서만 사용하거나 suspend 함수 내에서 작업을 병렬적으로 처리할 때 사용한다. <br />
suspend 함수 내에서 시작되는 Coroutine은 함수가 반환되면 중지되어야 한다. <br />
그러므로 반환 전에 Coroutine이 완료되도록 보장해야 한다. <br />
이를 위해 여러 Coroutine을 실행할 수 있는 <strong>coroutineScope</strong>를 정의할 수 있다. <br />
그리고 <strong>await()</strong> , <strong>awaitAll()</strong> 을 사용하여 함수가 반환되기 전에 Coroutine이 완료되도록 보장할 수 있다. <br />
아래 코드는 async를 통해 시작한 Coroutine을 await 함수를 사용하여, 실행된 Coroutine이 결과를 반환할 때 까지 기다린다. <br />
그러나 await 함수를 사용하지 않았더라도 coroutineScope Builder는 모든 Coroutine이 완료될 때 까지 기다린다. <br />
또한 coroutineScope는 Coroutine이 발생시키는 Exception(예외)를 호출자에게 전파한다. <br />
await()를 사용한 코드는 다음과 같다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>suspend fun fetchTwoDocs() =
    coroutineScope {
        val deferredOne = async { fetchDoc(1) }
        val deferredTwo = async { fetchDoc(2) }
        deferredOne.await()
        deferredTwo.await()
    }
</code></pre></div></div>

<p>awaitAll()을 사용한 코드는 다음과 같다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// called on any Dispatcher (any thread, possibly Main)
suspend fun fetchTwoDocs() =
    coroutineScope {
        // fetch two docs at the same time
        val deferreds = listOf(
            // async returns a result for the first doc
            async { fetchDoc(1) },
            // async returns a result for the second doc
            async { fetchDoc(2) }
        )

        // use awaitAll to wait for both network requests
        deferreds.awaitAll()
    }
</code></pre></div></div>

<h4 id="coroutinescope">CoroutineScope</h4>
<p>CoroutineScope는 launch 혹은 async로 생성된 Coroutine을 추적한다. <br />
실행 중인 Coroutine은 <em>scope.cancel()</em> 을 호출하여 취소할 수 있다. <br />
ViewModel이나 Lifecycle은 자체 CoroutineScope를 제공한다. <br />
ViewModel은 viewModelScope가 있고, Lifecycle에는 lifecycleScope가 있다. <br />
그러나 CoroutineScope는 Coroutine을 실행하진 않는다. <br />
<em>scope.cancel()</em> 에 의해 Coroutine이 한 번 취소되면 다시는 해당 scope에서 Coroutine을 생성할 수 없다. <br />
즉, <em>scope.cancel()</em> 은 해당 클래스가 destroy된 경우에만 사용해야 한다. <br />
ViewModel의 경우 <em>onCleared()</em> 메서드에서 자동으로 취소된다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ExampleClass {

    // Job and Dispatcher are combined into a CoroutineContext which
    // will be discussed shortly
    val scope = CoroutineScope(Job() + Dispatchers.Main)

    fun exampleMethod() {
        // Starts a new coroutine within the scope
        scope.launch {
            // New coroutine that can call suspend functions
            fetchDocs()
        }
    }

    fun cleanUp() {
        // Cancel the scope to cancel ongoing coroutines work
        scope.cancel()
    }
}
</code></pre></div></div>

<h4 id="job">Job</h4>
<p><strong>Job</strong>은 Coroutine을 다루기 위해 사용한다. <br />
launch나 async로 만들어진 Coroutine은 Coroutine을 고유하게 식별하고 lifecycle을 관리하는 Job 인스턴스를 반환한다. <br />
다음 예시 코드와 같이 Job을 CoroutineScope에 전달하여 lifecycler을 관리할 수 있다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ExampleClass {
    ...
    fun exampleMethod() {
        // Handle to the coroutine, you can control its lifecycle
        val job = scope.launch {
            // New coroutine
        }

        if (...) {
            // Cancel the coroutine started above, 
            // this doesn't affect the scope
            // this coroutine was launched in
            job.cancel()
        }
    }
}
</code></pre></div></div>

<h4 id="coroutinecontext">CoroutineContext</h4>
<p>CoroutineContext는 다음 요소를 사용하여 Coroutine의 동작을 정의한다.</p>
<ul>
  <li>Job: Coroutine의 lifecycle 제어</li>
  <li>CoroutineDispatcher: 적절한 Thread에 작업 전달</li>
  <li>CoroutineName: Coroutine의 이름. 디버깅 시 사용</li>
  <li>CoroutineExceptionHandler: uncaught Exception 처리</li>
</ul>

<p>scope 내에서 만들어진 Coroutine은 새로운 Job 인스턴스가 새 Coroutine에 할당되고 CoroutineContext 요소는 해당 scope에서 상속된다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ExampleClass {
    val scope = CoroutineScope(Job() + Dispatchers.Main)

    fun exampleMethod() {
        // Starts a new coroutine on Dispatchers.Main 
        // as it's the scope's default
        val job1 = scope.launch {
            // New coroutine with CoroutineName = "coroutine" (default)
        }

        // Starts a new coroutine on Dispatchers.Default
        val job2 = scope.launch(
            Dispatchers.Default + CoroutineName("BackgroundCoroutine")
            ) {
                // New coroutine with CoroutineName 
                // = "BackgroundCoroutine" (overridden)
        }
    }
}
</code></pre></div></div>

<h4 id="recommendation">Recommendation</h4>
<h5 id="inject-dispatcher">Inject Dispatcher</h5>
<p>새 Coroutine을 만들거나 withContext를 호출할 때 Dispatchers를 하드코딩 하지 않는 것이 좋다. <br />
하드코딩 시 테스트가 어렵기 때문이다.</p>
<h5 id="안전한-suspend-함수">안전한 suspend 함수</h5>
<p>suspend 함수는 메인 Thread에서 호출하기 때문에 main-safe 해야 한다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class NewsRepository(private val ioDispatcher: CoroutineDispatcher) {

    // As this operation is manually retrieving the news from the server
    // using a blocking HttpURLConnection, it needs to move the execution
    // to an IO dispatcher to make it main-safe
    suspend fun fetchLatestNews(): List&lt;Article&gt; {
        withContext(ioDispatcher) { }
    }
}

// This use case fetches the latest news and the associated author.
class GetLatestNewsWithAuthorsUseCase(
    private val newsRepository: NewsRepository,
    private val authorsRepository: AuthorsRepository
) {
    // This method doesn't need to worry about moving the execution of the
    // coroutine to a different thread as newsRepository is main-safe.
    // The work done in the coroutine is lightweight as it only creates
    // a list and add elements to it
    suspend operator fun invoke(): List&lt;ArticleWithAuthor&gt; {
        val news = newsRepository.fetchLatestNews()

        val response: List&lt;ArticleWithAuthor&gt; = mutableEmptyList()
        for (article in news) {
            val author = authorsRepository.getAuthor(article.author)
            response.add(ArticleWithAuthor(article, author))
        }
        return Result.Success(response)
    }
}
</code></pre></div></div>
<h5 id="viewmodel에서의-coroutine-생성">ViewModel에서의 Coroutine 생성</h5>
<p>View에서 Coroutine을 만들고 ViewModel에서 suspend 함수를 사용하지 말아야 한다. <br />
이러한 경우 테스트가 어렵고 configuration 변경에 수동으로 처리해야 한다. <br />
ViewModel에서 Coroutine을 생성한다면 단위 테스트를 진행할 수 있고, viewModelScope에서 실행된 작업은 configuration 변경에도 자동으로 유지된다.</p>
<h5 id="globalscope-금지">GlobalScope 금지</h5>
<p>GlobalScope는 어느 Job에도 종속되지 않고, Application의 lifecycle을 따른다. <br />
그러나 테스트가 어렵고 실행을 제어할 수 없으며 공통 CoroutineContext를 가질 수 없다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// DO inject an external scope instead of using GlobalScope.
// GlobalScope can be used indirectly. Here as a default parameter makes sense.
class ArticlesRepository(
    private val articlesDataSource: ArticlesDataSource,
    private val externalScope: CoroutineScope = GlobalScope,
    private val defaultDispatcher: CoroutineDispatcher = Dispatchers.Default
) {
    // As we want to complete bookmarking the article even if the user moves
    // away from the screen, the work is done creating a new coroutine
    // from an external scope
    suspend fun bookmarkArticle(article: Article) {
        externalScope.launch(defaultDispatcher) {
            articlesDataSource.bookmarkArticle(article)
        }
            .join() // Wait for the coroutine to complete
    }
}

// DO NOT use GlobalScope directly
class ArticlesRepository(
    private val articlesDataSource: ArticlesDataSource,
) {
    // As we want to complete bookmarking the article
    // even if the user moves away from the screen,
    // the work is done creating a new coroutine with GlobalScope
    suspend fun bookmarkArticle(article: Article) {
        GlobalScope.launch {
            articlesDataSource.bookmarkArticle(article)
        }
            .join() // Wait for the coroutine to complete
    }
}
</code></pre></div></div>

<h5 id="reference">Reference:</h5>

<ol>
  <li><a href="https://developer.android.com/kotlin/coroutines">Kotlin coroutines on Android</a></li>
</ol>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/15balloon" style="background-image: url(/assets/images/15balloon_profile.png)"><span class="hidden">15balloon's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/15balloon">15balloon</a></h4>

                        
                            <p> Android Developer</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Seoul, Republic of Korea</span>
                            <span class="author-link icon-link"><a href="http://15balloon.github.io/"> 15balloon.github.io/</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=Kotlin Coroutines 정리: 2&amp;url=https://15balloon.github.io2023-09-23-Kotlin-Coroutines-2"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://15balloon.github.io2023-09-23-Kotlin-Coroutines-2"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=https://15balloon.github.io2023-09-23-Kotlin-Coroutines-2"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            

            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/cover1.jpg)" href="/2024-01-05-Clean-Architecture">
            <section class="post">
                <h2>Clean Architecture 알아보기</h2>
                <p>OlymPos 프로젝트를 시작하면서 공부해야 겠다고 마음먹은 것들이 많았는데, 그중 하나가 클린 아키텍처다. 다들 클린 아키텍처...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/cover1.jpg)" href="/2023-09-22-Kotlin-Coroutines-1">
            <section class="post">
                <h2>Kotlin Coroutines 정리: 1</h2>
                <p>Kotlin을 사용해 Android 앱 개발을 하는 사람이라면 비동기적으로 코드를 실행시키기 위해 Coroutine 한 번쯤은 다...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">15balloon</a> &copy; 2024</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyllt/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', '', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for 15balloon -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
